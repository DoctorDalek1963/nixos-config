{
  pkgs,
  lib,
  config,
  ...
}: let
  cfg = config.setup.homeServer;
  cfgMs = cfg.mediaServer;

  jsTransgenderSymbols =
    # javascript
    ''
      function fixTransgenderSymbols() {
          const transFemmeSvgPath = "m 112,0 c 6.5,0 12.3,3.9 14.8,9.9 2.5,6 1.1,12.9 -3.5,17.4 l -31,31 19.7,19.8 7,-7 c 9.4,-9.4 24.6,-9.4 33.9,0 9.3,9.4 9.4,24.6 0,33.9 l -7,7 15.2,15.2 C 187.7,107.6 220.5,96 256,96 c 98.13719,0 160,74.92654 160,160 0,80.2 -59,146.6 -136,158.2 V 432 h 16 c 13.3,0 24,10.7 24,24 0,13.3 -10.7,24 -24,24 h -16 v 8 c 0,13.3 -10.7,24 -24,24 -13.3,0 -24,-10.7 -24,-24 v -8 h -16 c -13.3,0 -24,-10.7 -24,-24 0,-13.3 10.7,-24 24,-24 h 16 V 414.2 C 155,402.6 96,336.2 96,256 c 0,-35.5 11.6,-68.3 31.2,-94.9 l -15.2,-15.2 -7,7 c -9.4,9.4 -24.6,9.4 -33.9,0 -9.3,-9.4 -9.4,-24.6 0,-33.9 l 7,-7 -19.8,-19.7 -31,31 c -4.6,4.6 -11.5,5.9 -17.4,3.5 C 4,124.4 0,118.5 0,112 V 16 C 0,7.2 7.2,0 16,0 Z m 240,256 c 0,-53.01937 -42.98067,-95.99996 -96,-95.99996 -53.01933,0 -96,42.98059 -96,95.99996 0,53.01937 42.98067,95.99996 96,95.99996 53.01933,0 96,-42.98059 96,-95.99996 z";

          const transMascSvgPath = "m 112,0 c 6.5,0 12.3,3.9 14.8,9.9 2.5,6 1.1,12.9 -3.5,17.4 l -31,31 19.7,19.8 7,-7 c 9.4,-9.4 24.6,-9.4 33.9,0 9.3,9.4 9.4,24.6 0,33.9 l -7,7 15.2,15.2 C 187.7,107.6 220.5,96 256,96 c 35.5,0 68.3,11.6 94.9,31.2 l 68.8,-68.8 -31,-31 C 384.1,22.8 382.8,15.9 385.2,10 387.6,4.1 393.5,0.1 400,0.1 h 96 c 8.8,0 16,7.2 16,16 v 96 c 0,6.5 -3.9,12.3 -9.9,14.8 -6,2.5 -12.9,1.1 -17.4,-3.5 l -31,-31 -68.8,68.8 c 19.5,26.5 31.42031,59.30145 31.1,94.8 -0.61538,68.2 -48.32001,156.46287 -159.31215,156.55509 C 145.6957,412.64731 97.1694,320.71174 96,256 c -0.641413,-35.49421 11.6,-68.3 31.2,-94.9 l -15.2,-15.2 -7,7 c -9.4,9.4 -24.6,9.4 -33.9,0 -9.3,-9.4 -9.4,-24.6 0,-33.9 l 7,-7 -19.8,-19.7 -31,31 c -4.6,4.6 -11.5,5.9 -17.4,3.5 C 4,124.4 0,118.5 0,112 V 16 C 0,7.2 7.2,0 16,0 Z m 240,256 c 0,-53.01937 -42.98067,-95.99996 -96,-95.99996 -53.01933,0 -96,42.98059 -96,95.99996 0,53.01937 42.98067,95.99996 96,95.99996 53.01933,0 96,-42.98059 96,-95.99996 z";

          for (const svg of document.getElementsByTagName("svg")) {
              const firstChild = svg.children[0];

              if (firstChild.tagName === "title") {
                  const gender = firstChild.innerHTML;
                  let path = svg.children[1];

                  if (gender === "Transgender Female") {
                      path.setAttribute("d", transFemmeSvgPath);
                  } else if (gender === "Transgender Male") {
                      path.setAttribute("d", transMascSvgPath);
                  }
              }
          }
      }

      setInterval(fixTransgenderSymbols, 5000);
    '';
in {
  config = lib.mkIf (cfg.enable && cfgMs.enable && cfgMs.porn) {
    systemd.tmpfiles.settings.stash = {
      "${config.services.stash.dataDir}/custom.js".C = {
        user = "stash";
        group = "media";
        mode = "755";
        argument = toString (pkgs.writeTextFile {
          name = "stash-custom.js";
          text = ''
            ${jsTransgenderSymbols}
          '';
        });
      };
    };
  };
}
